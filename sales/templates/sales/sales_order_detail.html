{% extends 'base.html' %}
{% load humanize %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">{{ title }}</h1>
            <div>
                {# Edit Button #}
                {% if perms.sales.change_salesorder and sales_order.status != 'delivered' and sales_order.status != 'cancelled' %}
                <a href="{% url 'sales:edit_sales_order' sales_order.pk %}" class="btn btn-warning btn-sm shadow-sm me-2">
                    <i class="fas fa-edit fa-sm"></i> Edit Order
                </a>
                {% endif %}

                {# Fulfill Button #}
                {% if sales_order.status == 'confirmed' %}
                    <a href="{% url 'sales:fulfill_sales_order' sales_order.pk %}" class="btn btn-success btn-sm shadow-sm me-2">
                        <i class="fas fa-shipping-fast fa-sm"></i> Fulfill Order
                    </a>
                {% endif %}

                {# Export Button #}
                <a href="{% url 'sales:export_sales_order_pdf' sales_order.pk %}" class="btn btn-secondary btn-sm shadow-sm">
                    <i class="fas fa-file-pdf fa-sm"></i> Export to PDF
                </a>
            </div>
    </div>

    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="card shadow h-100">
                <div class="card-header py-3"><h6 class="m-0 font-weight-bold text-primary">Customer Information</h6></div>
                <div class="card-body">
                    <h5>{{ sales_order.customer.name }}</h5>
                    {% if sales_order.customer.email %}<p class="mb-1"><i class="fas fa-envelope fa-fw me-2 text-gray-500"></i>{{ sales_order.customer.email }}</p>{% endif %}
                    {% if sales_order.customer.phone %}<p class="mb-1"><i class="fas fa-phone fa-fw me-2 text-gray-500"></i>{{ sales_order.customer.phone }}</p>{% endif %}
                    {% if sales_order.customer.address %}<p class="mb-1"><i class="fas fa-map-marker-alt fa-fw me-2 text-gray-500"></i>{{ sales_order.customer.address|linebreaksbr }}</p>{% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-6 mb-4">
            <div class="card shadow h-100">
                <div class="card-header py-3"><h6 class="m-0 font-weight-bold text-primary">Order Information</h6></div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6"><strong>Order Date:</strong></div><div class="col-6">{{ sales_order.order_date|date:"d M Y" }}</div>
                        <div class="col-6"><strong>Expected Delivery:</strong></div><div class="col-6">{{ sales_order.expected_delivery_date|date:"d M Y"|default:"N/A" }}</div>
                        <div class="col-6"><strong>Status:</strong></div><div class="col-6"><span class="badge {% if sales_order.status == 'delivered' %}bg-success{% elif sales_order.status == 'confirmed' %}bg-info text-dark{% elif sales_order.status == 'cancelled' %}bg-danger{% else %}bg-secondary{% endif %}">{{ sales_order.get_status_display }}</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow mb-4">
        <div class="card-header py-3"><h6 class="m-0 font-weight-bold text-primary">Order Items</h6></div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered" width="100%" cellspacing="0">
                    <thead class="table-light">
                        <tr>
                            <th>Product</th>
                            <th class="text-end">Quantity</th>
                            <th class="text-end">Unit Price</th>
                            <th class="text-end">Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in sales_order.items.all %}
                        <tr>
                            <td>
                                {{ item.product.name }}
                                {% if item.lot_serial %}
                                <small class="text-muted d-block">Lot: {{ item.lot_serial.lot_number }}</small>
                                {% endif %}
                            </td>
                            <td class="text-end">{{ item.quantity }}</td>
                            <td class="text-end">{{ DEFAULT_CURRENCY_SYMBOL }}{{ item.unit_price|floatformat:2 }}</td>
                            <td class="text-end">{{ DEFAULT_CURRENCY_SYMBOL }}{{ item.subtotal|floatformat:2 }}</td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="4" class="text-center">No items in this sales order.</td></tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr class="table-light">
                            <td colspan="3" class="text-end"><strong>Total Amount</strong></td>
                            <td class="text-end"><strong>{{ DEFAULT_CURRENCY_SYMBOL }}{{ sales_order.total_amount|floatformat:2 }}</strong></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    {% if associated_returns %}
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-danger">Associated Returns</h6>
        </div>
        <div class="card-body">
            {% for return_instance in associated_returns %}
            <div class="mb-4">
                <h5 class="text-muted">Return #{{ return_instance.id }} on {{ return_instance.return_date|date:"d M, Y" }}</h5>
                <p><strong>Reason:</strong> {{ return_instance.reason|default:"No reason provided." }}</p>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered" width="100%" cellspacing="0">
                        <thead class="table-light">
                            <tr>
                                <th>Returned Product</th>
                                <th class="text-end">Returned Qty</th>
                                <th class="text-end">Unit Price</th>
                                <th class="text-end">Returned Value</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in return_instance.items.all %}
                            <tr>
                                <td>
                                    {{ item.product.name }}
                                    {% if item.lot_serial %}
                                    <small class="text-muted d-block">Lot: {{ item.lot_serial.lot_number }}</small>
                                    {% endif %}
                                </td>
                                <td class="text-end">{{ item.quantity }}</td>
                                <td class="text-end">{{ DEFAULT_CURRENCY_SYMBOL }}{{ item.unit_price|floatformat:2 }}</td>
                                <td class="text-end">{{ DEFAULT_CURRENCY_SYMBOL }}{{ item.subtotal|floatformat:2 }}</td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="4" class="text-center">No items found for this return.</td></tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr class="table-light">
                                <td colspan="3" class="text-end"><strong>Total Returned Value</strong></td>
                                <td class="text-end"><strong>{{ DEFAULT_CURRENCY_SYMBOL }}{{ return_instance.total_amount|floatformat:2 }}</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
            {% if not forloop.last %}<hr>{% endif %}
            {% endfor %}
        </div>
    </div>
    {% endif %}
    {% if sales_order.notes %}
    <div class="card shadow">
        <div class="card-header py-3"><h6 class="m-0 font-weight-bold text-primary">Notes</h6></div>
        <div class="card-body">{{ sales_order.notes|linebreaksbr }}</div>
    </div>
    {% endif %}

</div>
{% endblock %}